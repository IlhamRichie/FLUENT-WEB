{% extends "base.html" %}

{% block title %}
    <span class="lang-id">Latihan Wawancara AI</span><span class="lang-en">AI Interview Practice</span> - {{ app_name | default('FLUENT') }}
{% endblock %}

{% block head_extra %}
    {# Font Awesome sudah ada di base.html, Font Inter juga #}
    <style>
        /* Gaya spesifik untuk halaman ini - Idealnya dipindah ke style.css global */
        .interview-simulation-container {
            max-width: 1140px; /* Bootstrap .container-lg */
        }
        
        .simulation-main-card {
            background-color: var(--fluent-background, #fff);
            box-shadow: var(--fluent-shadow-lg, 0 1rem 3rem rgba(0,0,0,.175));
            border-radius: var(--fluent-card-radius, 0.75rem);
            padding: 1.5rem;
            border: 1px solid var(--fluent-border-color-soft, #eff2f5);
        }
        
        @media (min-width: 768px) { /* md */
            .simulation-main-card {
                padding: 2.5rem;
            }
        }

        .video-placeholder-sim {
            background-color: #212529; /* Bootstrap dark */
            aspect-ratio: 16 / 9;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border-radius: var(--fluent-border-radius, 0.5rem);
            color: #ced4da; /* Bootstrap gray-400 */
            position: relative;
            overflow: hidden;
            box-shadow: var(--fluent-shadow-sm);
        }
        
        .video-placeholder-sim .video-icon-placeholder { /* Mengganti .icon pada video placeholder */
            font-size: 3.5rem; /* Sesuaikan ukuran ikon Font Awesome */
            margin-bottom: 0.5rem;
        }
        
        .video-placeholder-sim .text {
            font-size: 1.125rem; /* Mirip text-lg */
        }

        .talking-head-sim {
            width: 70px; /* Sedikit lebih kecil */
            height: 70px;
            background-color: var(--fluent-secondary, #6c757d);
            border-radius: 50%;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 0 0 rgba(25, 135, 84, 0); /* Bootstrap success color, initially transparent */
            transition: box-shadow 0.3s ease;
        }
        
        .talking-head-sim.is-talking {
            animation: talk-glow-sim 1.5s infinite;
        }
        
        .talking-head-face-sim {
            width: 45px;
            height: 45px;
            background-color: #adb5bd; /* Bootstrap gray-500 */
            border-radius: 50%;
            position: relative;
        }
        
        .talking-head-mouth-sim {
            width: 18px;
            height: 4px;
            background-color: #212529; /* Bootstrap dark */
            border-radius: 2px;
            position: absolute;
            bottom: 8px;
            left: 50%;
            transform: translateX(-50%);
            transition: height 0.15s ease-in-out;
        }
        
        .talking-head-sim.is-talking .talking-head-mouth-sim {
            animation: talk-mouth-sim 0.4s infinite alternate;
        }

        @keyframes talk-glow-sim { /* Menggunakan warna Bootstrap success */
            0% { box-shadow: 0 0 3px 1px rgba(25, 135, 84, 0.6); }
            50% { box-shadow: 0 0 15px 7px rgba(25, 135, 84, 0.25); }
            100% { box-shadow: 0 0 3px 1px rgba(25, 135, 84, 0.6); }
        }
        
        @keyframes talk-mouth-sim {
            from { height: 2px; }
            to { height: 8px; }
        }

        .question-display-area {
            background-color: var(--fluent-light, #f8f9fa);
            padding: 1rem 1.25rem;
            border-radius: var(--fluent-border-radius, 0.5rem);
            box-shadow: var(--fluent-shadow-sm);
            border: 1px solid var(--fluent-border-color-soft, #eff2f5);
        }
        
        .question-display-area .question-text {
            font-weight: 600;
            font-size: 1.15rem; /* Sedikit disesuaikan */
            color: var(--fluent-primary, #0d6efd);
            margin-bottom: 0rem; /* Dihapus karena ada progress bar */
        }

        .transcript-area-custom {
            min-height: 120px; /* Sedikit lebih tinggi */
            max-height: 250px;
            overflow-y: auto;
            background-color: #fff;
            border: 1px solid var(--fluent-border-color, #dee2e6);
            border-radius: var(--fluent-border-radius);
            padding: 0.75rem 1rem;
            font-style: italic;
            color: var(--fluent-text-muted, #6c757d);
            line-height: 1.6;
        }
        
        .transcript-area-custom::-webkit-scrollbar { width: 8px; }
        .transcript-area-custom::-webkit-scrollbar-track { background: var(--fluent-light, #f8f9fa); border-radius: 10px; }
        .transcript-area-custom::-webkit-scrollbar-thumb { background: #adb5bd; border-radius: 10px; } /* Bootstrap gray-500 */
        .transcript-area-custom::-webkit-scrollbar-thumb:hover { background: var(--fluent-secondary, #6c757d); }
        
        .interim-transcript-custom { 
            color: var(--fluent-text-muted, #6c757d);
            opacity: 0.65;
        }

        .analysis-card-sim {
            background-color: #fff;
            padding: 1.25rem;
            border-radius: var(--fluent-border-radius);
            box-shadow: var(--fluent-shadow);
            height: 100%; /* Agar tinggi kartu sama dalam satu baris jika d-flex */
            border: 1px solid var(--fluent-border-color-soft, #eff2f5);
        }
        
        .analysis-card-sim h3 {
            font-size: 1.1rem; /* Sedikit lebih kecil dari h5 Bootstrap standar */
            font-weight: 600;
            color: var(--fluent-primary, #0d6efd);
            margin-bottom: 1rem;
        }
        
        .analysis-card-sim h3 i.fas { /* Atur warna ikon Font Awesome */
            /* Warna sudah di-set di HTML dengan text-warning, text-info, text-success */
            font-size: 0.9em; /* Relatif terhadap h3 */
        }
        
        .analysis-card-sim .analysis-item p {
            font-size: 0.875rem; /* Bootstrap .small */
            color: var(--fluent-text-muted, #6c757d);
            margin-bottom: 0.5rem;
        }
        
        .analysis-card-sim .analysis-item p .analysis-label {
            font-weight: 500; /* Bootstrap .fw-medium */
        }
        
        .analysis-card-sim .analysis-item p .analysis-value {
            color: var(--fluent-text-dark, #212529);
            font-weight: 600; /* Bootstrap .fw-semibold */
        }

        .recording-indicator-dot-sim {
            display: inline-block;
            width: 10px; /* Sedikit lebih kecil */
            height: 10px;
            background-color: #dc3545; /* Bootstrap danger */
            border-radius: 50%;
            animation: pulse-sim 1.2s infinite ease-in-out;
            vertical-align: middle;
        }
        
        @keyframes pulse-sim {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.4; transform: scale(0.75); }
        }
        
        .btn-microphone { /* Efek ripple pada tombol Start */
            position: relative;
            overflow: hidden;
        }
        
        .btn-microphone::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 5px;
            height: 5px;
            background: rgba(255, 255, 255, 0.5);
            opacity: 0;
            border-radius: 100%;
            transform: scale(1, 1) translate(-50%, -50%);
            transform-origin: 50% 50%;
        }
        
        .btn-microphone:not(:disabled):active::after { /* Hanya aktif jika tombol tidak disabled */
            animation: ripple-sim 0.7s ease-out;
        }
        
        @keyframes ripple-sim {
            0% {
                transform: scale(0, 0) translate(-50%, -50%);
                opacity: 0.5;
            }
            100% {
                transform: scale(25, 25) translate(-50%, -50%); /* Sesuaikan skala ripple */
                opacity: 0;
            }
        }
        
        .analysis-value { /* Kelas untuk nilai analisis yang akan diberi warna feedback */
            transition: color 0.3s ease, transform 0.2s ease;
            display: inline-block; /* Agar transform scale bekerja */
        }
        
        .positive-feedback { color: var(--bs-success, #198754) !important; }
        .neutral-feedback { color: var(--bs-warning, #ffc107) !important; } /* Gunakan warna warning Bootstrap */
        .negative-feedback { color: var(--bs-danger, #dc3545) !important; }
        
        .feedback-animation {
            animation: feedback-pulse-sim 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        
        @keyframes feedback-pulse-sim {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        .progress-thin { /* Progress bar untuk timer pertanyaan */
            height: 6px;
            border-radius: var(--fluent-border-radius);
        }
        .progress-bar { /* Transisi untuk progress bar */
             transition: width 0.25s ease-in-out !important;
        }
    </style>
{% endblock %}

{% block content %}
<div class="container my-5 interview-simulation-container">
    <div class="simulation-main-card">
        <header class="mb-5 text-center">
            <h1 class="display-5 fw-bold text-primary">
                <span class="lang-id">Latihan Wawancara AI (Simulasi)</span>
                <span class="lang-en">AI Interview Practice (Simulation)</span>
            </h1>
            <p class="text-muted mt-2 fs-5">
                <span class="lang-id">Jawab pertanyaan secara lisan dan dapatkan feedback instan.</span>
                <span class="lang-en">Answer questions verbally and get instant feedback.</span>
            </p>
            <div class="mt-4">
                <button id="languageSwitcher" class="btn btn-sm btn-outline-secondary">
                    <span class="lang-id">Switch to English</span>
                    <span class="lang-en">Ganti ke Bahasa Indonesia</span>
                </button>
            </div>
        </header>

        <div class="row g-4">
            <div class="col-lg-8 d-flex flex-column">
                <div class="video-placeholder-sim mb-4">
                    <div id="talkingHead" class="talking-head-sim">
                        <div class="talking-head-face-sim">
                            <div class="talking-head-mouth-sim"></div>
                        </div>
                    </div>
                    <div class="text mt-3 text-white-50"> {# text-white-50 Bootstrap untuk teks lebih redup #}
                        <span class="lang-id">Simulasi Pewawancara AI</span>
                        <span class="lang-en">AI Interviewer Simulation</span>
                    </div>
                     <div id="aiSpeakerStatus" class="position-absolute bottom-0 start-0 m-2 p-1 small rounded" style="background-color: rgba(0,0,0,0.6); color: white;">
                        <span class="lang-id">AI sedang menunggu...</span>
                        <span class="lang-en">AI is waiting...</span>
                    </div>
                </div>

                <div class="question-display-area mb-4">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <p class="question-text mb-0" id="currentQuestionDisplay">
                            <span class="lang-id">Pertanyaan akan muncul di sini...</span>
                            <span class="lang-en">Question will appear here...</span>
                        </p>
                        <span class="badge bg-primary rounded-pill">
                            <span class="lang-id">Pertanyaan <span id="currentQuestionNumber">0</span>/<span id="totalQuestions">0</span></span>
                            <span class="lang-en">Question <span id="currentQuestionNumber">0</span>/<span id="totalQuestions">0</span></span>
                        </span>
                    </div>
                    <div class="progress progress-thin">
                        <div id="questionTimer" class="progress-bar bg-info progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                </div>

                <div class="question-display-area mb-4">
                    <label for="transcript" class="form-label fw-medium mb-2">
                        <span class="lang-id">Jawaban Anda (Transkrip Suara):</span>
                        <span class="lang-en">Your Answer (Voice Transcript):</span>
                    </label>
                    <div id="transcript" class="transcript-area-custom" aria-live="polite">
                        <span class="lang-id">Tekan "Mulai Wawancara" dan izinkan akses mikrofon untuk berbicara...</span>
                        <span class="lang-en">Press "Start Interview" and allow microphone access to speak...</span>
                    </div>
                    <div class="mt-2 d-flex justify-content-between align-items-center">
                        <small class="text-muted">
                            <span class="lang-id">Panjang jawaban: <span id="answerLength" class="fw-medium">0</span> kata</span>
                            <span class="lang-en">Answer length: <span id="answerLength" class="fw-medium">0</span> words</span>
                        </small>
                        <div>
                            <button id="clearTranscriptBtn" title="Clear Transcript" class="btn btn-sm btn-outline-secondary me-2" disabled>
                                <i class="fas fa-eraser"></i>
                                <span class="visually-hidden lang-id">Hapus Transkrip</span>
                                <span class="visually-hidden lang-en">Clear Transcript</span>
                            </button>
                            <button id="playAnswerBtn" title="Play Answer" class="btn btn-sm btn-outline-primary" disabled>
                                <i class="fas fa-play"></i>
                                <span class="visually-hidden lang-id">Dengarkan Jawaban</span>
                                <span class="visually-hidden lang-en">Play Answer</span>
                            </button>
                        </div>
                    </div>
                </div>

                <div class="d-grid gap-2 d-sm-flex justify-content-sm-center mt-auto pt-3">
                    <button id="startButton" class="btn btn-primary btn-lg flex-grow-1 flex-sm-grow-0 btn-microphone">
                        <i class="fas fa-microphone-alt me-2"></i>
                        <span class="lang-id">Mulai Menjawab</span>
                        <span class="lang-en">Start Answering</span>
                    </button>
                    <button id="stopButton" class="btn btn-danger btn-lg flex-grow-1 flex-sm-grow-0" disabled>
                        <i class="fas fa-stop-circle me-2"></i>
                        <span class="lang-id">Hentikan Jawaban</span>
                        <span class="lang-en">Stop Answer</span>
                    </button>
                     <button id="nextQuestionButton" class="btn btn-success btn-lg flex-grow-1 flex-sm-grow-0" style="display: none;">
                        <i class="fas fa-arrow-right me-2"></i>
                        <span class="lang-id">Pertanyaan Berikutnya</span>
                        <span class="lang-en">Next Question</span>
                    </button>
                </div>
                <p id="interviewStatus" class="text-center text-muted small mt-3">
                    <span class="lang-id">Status: Menunggu untuk memulai</span>
                    <span class="lang-en">Status: Waiting to start</span>
                    <span id="recordingIndicator" class="recording-indicator-dot-sim ms-2" style="display: none;"></span>
                </p>
            </div>

            <div class="col-lg-4 d-flex flex-column">
                <div class="analysis-card-sim mb-3 flex-grow-1"> {# mb-3 Bootstrap untuk spacing #}
                    <h3 class="h5 fw-semibold text-primary mb-3 d-flex align-items-center">
                        <i class="fas fa-smile-beam me-2 text-warning"></i>
                        <span class="lang-id">Deteksi Emosi</span><span class="lang-en">Emotion Detection</span>
                    </h3>
                    <div class="analysis-item">
                        <p><span class="analysis-label lang-id">Kondisi Emosional:</span><span class="analysis-label lang-en">Emotional State:</span> <span id="emotionState" class="analysis-value">-</span></p>
                        <p><span class="analysis-label lang-id">Tingkat Kepercayaan Diri:</span><span class="analysis-label lang-en">Confidence Level:</span> <span id="confidenceLevel" class="analysis-value">-</span></p>
                        <p><span class="analysis-label lang-id">Kegugupan:</span><span class="analysis-label lang-en">Nervousness:</span> <span id="nervousnessLevel" class="analysis-value">-</span></p>
                    </div>
                </div>

                <div class="analysis-card-sim mb-3 flex-grow-1">
                    <h3 class="h5 fw-semibold text-primary mb-3 d-flex align-items-center">
                        <i class="fas fa-bullhorn me-2 text-info"></i>
                        <span class="lang-id">Analisis Ucapan</span><span class="lang-en">Speech Analysis</span>
                    </h3>
                     <div class="analysis-item">
                        <p><span class="analysis-label lang-id">Kecepatan Bicara (KPM):</span><span class="analysis-label lang-en">Speech Rate (WPM):</span> <span id="speechRate" class="analysis-value">-</span></p>
                        <p><span class="analysis-label lang-id">Kata Pengisi:</span><span class="analysis-label lang-en">Filler Words:</span> <span id="fillerWords" class="analysis-value">-</span></p>
                        <p><span class="analysis-label lang-id">Kejelasan:</span><span class="analysis-label lang-en">Clarity:</span> <span id="speechClarity" class="analysis-value">-</span></p>
                    </div>
                </div>

                <div class="analysis-card-sim flex-grow-1">
                    <h3 class="h5 fw-semibold text-primary mb-3 d-flex align-items-center">
                        <i class="fas fa-child me-2 text-success"></i>
                        <span class="lang-id">Analisis Bahasa Tubuh</span><span class="lang-en">Body Language Analysis</span>
                    </h3>
                     <div class="analysis-item">
                        <p><span class="analysis-label lang-id">Postur:</span><span class="analysis-label lang-en">Posture:</span> <span id="postureDisplay" class="analysis-value">-</span></p>
                        <p><span class="analysis-label lang-id">Kontak Mata:</span><span class="analysis-label lang-en">Eye Contact:</span> <span id="eyeContact" class="analysis-value">-</span></p>
                        <p><span class="analysis-label lang-id">Gestur Tangan:</span><span class="analysis-label lang-en">Hand Gestures:</span> <span id="handGestures" class="analysis-value">-</span></p>
                    </div>
                </div>
            </div>
        </div>

        <footer class="mt-5 pt-4 border-top text-center small text-muted">
            <p>&copy; <span id="currentYear"></span> {{ app_name | default('Simulasi Latihan Wawancara AI') }}.
                <span class="lang-id">Hanya untuk tujuan demonstrasi.</span>
                <span class="lang-en">For demonstration purposes only.</span>
            </p>
            <p>
                <span class="lang-id">Tidak ada data video/audio yang direkam atau dianalisis secara nyata.</span>
                <span class="lang-en">No video/audio data is actually recorded or analyzed.</span>
            </p>
             <p class="mt-4">
                <a href="{{ url_for('web.web_profile_route') }}" id="backToProfileLink" class="btn btn-sm btn-outline-secondary">
                    <i class="fas fa-arrow-left me-1"></i>
                    <span class="lang-id">Kembali ke Profil</span>
                    <span class="lang-en">Back to Profile</span>
                </a>
            </p>
        </footer>
    </div>
</div>
{% endblock %}

{% block scripts_extra %}
<script>
    // --- DOM Elements ---
    const startButton = document.getElementById("startButton");
    const stopButton = document.getElementById("stopButton");
    const nextQuestionButton = document.getElementById("nextQuestionButton");
    const interviewStatus = document.getElementById("interviewStatus");
    const transcriptDiv = document.getElementById("transcript");
    const recordingIndicator = document.getElementById("recordingIndicator");
    const currentQuestionDisplay = document.getElementById("currentQuestionDisplay");
    const languageSwitcher = document.getElementById("languageSwitcher");
    // const backToProfileLink = document.getElementById("backToProfileLink"); // Link sudah di-set via url_for
    const aiSpeakerStatus = document.getElementById("aiSpeakerStatus");
    const talkingHead = document.getElementById("talkingHead");
    const clearTranscriptBtn = document.getElementById("clearTranscriptBtn");
    const playAnswerBtn = document.getElementById("playAnswerBtn");
    const answerLengthEl = document.getElementById("answerLength"); // Diberi akhiran El agar tidak bentrok
    const currentQuestionNumberEl = document.getElementById("currentQuestionNumber");
    const totalQuestionsEl = document.getElementById("totalQuestions");
    const questionTimerEl = document.getElementById("questionTimer");


    // Analysis display elements
    const emotionState = document.getElementById("emotionState");
    const confidenceLevel = document.getElementById("confidenceLevel");
    const nervousnessLevel = document.getElementById("nervousnessLevel");
    const speechRate = document.getElementById("speechRate");
    const fillerWords = document.getElementById("fillerWords");
    const speechClarity = document.getElementById("speechClarity");
    const postureDisplay = document.getElementById("postureDisplay");
    const eyeContact = document.getElementById("eyeContact");
    const handGestures = document.getElementById("handGestures");
    
    document.getElementById("currentYear").textContent = new Date().getFullYear();

    // --- State Variables ---
    let interviewInterval; // Untuk interval update analisis
    let isInterviewActive = false; // Status keseluruhan sesi wawancara
    let isRecognizing = false; // Status apakah SpeechRecognition sedang aktif
    let currentQuestionIndex = 0;
    let currentLanguage = localStorage.getItem('preferredLang') || document.documentElement.lang || 'id';
    let questionStartTime;
    let timerInterval;
    let currentFinalTranscript = ""; // Menyimpan transkrip final terakhir
    let audioContext;
    let audioBufferForPlayback; // Menyimpan audio buffer untuk diputar ulang
    let isPlayingAudio = false;
    let audioSourceNode;

    const QUESTION_TIME_LIMIT = 60; // Detik per pertanyaan

    // --- Speech Recognition Setup ---
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    let recognition;

    if (SpeechRecognition) {
        recognition = new SpeechRecognition();
        recognition.continuous = true; // Biarkan terus menerus, kita kontrol start/stop manual
        recognition.interimResults = true; // Dapatkan hasil sementara

        recognition.onstart = function() {
            console.log("Speech recognition has started.");
            isRecognizing = true;
            if (recordingIndicator) recordingIndicator.style.display = "inline-block";
            setInterviewStatusText("Mendengarkan...", "Listening...");
            if (talkingHead) talkingHead.classList.add('is-talking');
            if (aiSpeakerStatus) setAISpeakerStatusText("Saya mendengarkan jawaban Anda...", "I'm listening to your answer...");
        };

        recognition.onresult = function(event) {
            let interim_transcript = "";
            let final_transcript_segment = "";

            for (let i = event.resultIndex; i < event.results.length; ++i) {
                if (event.results[i].isFinal) {
                    final_transcript_segment += event.results[i][0].transcript + ' '; // Tambah spasi
                } else {
                    interim_transcript += event.results[i][0].transcript;
                }
            }
            
            if (final_transcript_segment) {
                currentFinalTranscript += final_transcript_segment;
                 if (playAnswerBtn) playAnswerBtn.disabled = false;
                 if (clearTranscriptBtn) clearTranscriptBtn.disabled = false;
            }

            if (transcriptDiv) {
                transcriptDiv.innerHTML = `<span class="interim-transcript-custom">${interim_transcript}</span>${currentFinalTranscript}`;
                transcriptDiv.scrollTop = transcriptDiv.scrollHeight;
                
                const wordCount = currentFinalTranscript.trim() === "" ? 0 : currentFinalTranscript.trim().split(/\s+/).length;
                if(answerLengthEl) answerLengthEl.textContent = wordCount;
            }
        };

        recognition.onerror = function(event) {
            console.error("Speech recognition error:", event.error);
            let errorMessageId = "Terjadi kesalahan pada pengenalan suara.";
            let errorMessageEn = "Speech recognition error.";
            // ... (penanganan error message seperti sebelumnya) ...
             if (event.error === "no-speech") { /* ... */ }
             else if (event.error === "audio-capture") { /* ... */ }
             else if (event.error === "not-allowed") { /* ... */ }

            setInterviewStatusText(errorMessageId, errorMessageEn, true);
            stopCurrentSpeechRecognition(false); // False karena bukan user yang stop
            if (talkingHead) talkingHead.classList.remove('is-talking');
            if (aiSpeakerStatus) setAISpeakerStatusText("Ada masalah dengan mikrofon.", "There was an issue with the microphone.");
            resetQuestionTimer();
        };

        recognition.onend = function() {
            console.log("Speech recognition has ended.");
            isRecognizing = false;
            if (recordingIndicator) recordingIndicator.style.display = "none";
            if (talkingHead) talkingHead.classList.remove('is-talking');
            // Jangan restart otomatis di sini, biarkan startInterview() yang mengontrol
            if (isInterviewActive && startButton.disabled) { // Jika interview masih aktif & tombol start disable (berarti sedang menjawab)
                 // Ini berarti recognition berhenti sendiri (misal karena jeda panjang)
                 // Tombol stop masih aktif, pengguna bisa klik stop atau start lagi
                 setInterviewStatusText("Perekaman suara berhenti. Tekan 'Mulai' untuk lanjut atau 'Hentikan Jawaban'.", 
                                        "Voice recording stopped. Press 'Start' to continue or 'Stop Answer'.");
            }
        };
    } else {
        // ... (Handling jika SpeechRecognition tidak didukung) ...
    }

    // ... (Data simulasi pertanyaan dan analisis tetap sama, pastikan lengkap) ...
    const interviewQuestions = [
        { id: "Ceritakan tentang diri Anda.", en: "Tell me about yourself." },
        { id: "Apa kekuatan terbesar Anda?", en: "What is your greatest strength?" },
        { id: "Apa kelemahan terbesar Anda?", en: "What is your greatest weakness?" },
        { id: "Di mana Anda melihat diri Anda dalam 5 tahun ke depan?", en: "Where do you see yourself in 5 years?" },
        { id: "Mengapa Anda tertarik dengan posisi ini?", en: "Why are you interested in this position?" },
        { id: "Mengapa kami harus mempekerjakan Anda?", en: "Why should we hire you?" }
    ];
    if(totalQuestionsEl) totalQuestionsEl.textContent = interviewQuestions.length;

    const emotions = [ /* ... data emosi ... */ ];
    const speechRatesData = [ /* ... data speech rates ... */ ];
    const fillerWordsData = [ /* ... data filler words ... */ ];
    const claritiesData = [ /* ... data clarities ... */ ];
    const posturesData = [ /* ... data postures ... */ ];
    const eyeContactsData = [ /* ... data eye contacts ... */ ];
    const handGesturesData = [ /* ... data hand gestures ... */ ];
     // Pastikan semua array data simulasi di atas diisi lengkap seperti di kode Anda sebelumnya

    // --- Helper Functions ---
    function getRandomElement(arr) { return arr[Math.floor(Math.random() * arr.length)]; }

    function applyFeedbackClass(element, feedbackType) { /* ... (sama seperti sebelumnya) ... */ }

    function updateAnalysisData() { /* ... (sama seperti sebelumnya, pastikan ID elemen benar) ... */ }

    function setBilingualText(element, textId, textEn) { /* ... (sama seperti sebelumnya) ... */ }
    
    function setInterviewStatusText(textId, textEn, isError = false) { /* ... (sama seperti sebelumnya) ... */ }
    
    function setAISpeakerStatusText(textId, textEn) { /* ... (sama seperti sebelumnya) ... */ }

    function startQuestionTimer() {
        clearInterval(timerInterval);
        let timeLeft = QUESTION_TIME_LIMIT;
        if (questionTimerEl) {
            questionTimerEl.style.width = "100%";
            questionTimerEl.classList.remove('bg-danger', 'bg-warning');
            questionTimerEl.classList.add('bg-info');
        }

        timerInterval = setInterval(() => {
            timeLeft--;
            const percentage = (timeLeft / QUESTION_TIME_LIMIT) * 100;
            if (questionTimerEl) questionTimerEl.style.width = percentage + "%";

            if (percentage < 25) {
                if (questionTimerEl) questionTimerEl.classList.replace('bg-warning', 'bg-danger');
            } else if (percentage < 50) {
                if (questionTimerEl) questionTimerEl.classList.replace('bg-info', 'bg-danger'); // Seharusnya bg-warning
                 if (questionTimerEl) questionTimerEl.classList.replace('bg-info', 'bg-warning');
            }

            if (timeLeft <= 0) {
                clearInterval(timerInterval);
                setInterviewStatusText("Waktu habis untuk pertanyaan ini!", "Time's up for this question!");
                stopCurrentAnswer(); // Otomatis hentikan jawaban dan tampilkan tombol Next
            }
        }, 1000);
    }

    function resetQuestionTimer() {
        clearInterval(timerInterval);
        if (questionTimerEl) {
            questionTimerEl.style.width = "0%";
            questionTimerEl.classList.remove('bg-danger', 'bg-warning');
            questionTimerEl.classList.add('bg-info');
        }
    }
    
    function displayQuestion() {
        resetQuestionTimer(); // Reset timer setiap pertanyaan baru
        if (currentQuestionIndex < interviewQuestions.length) {
            if(currentQuestionNumberEl) currentQuestionNumberEl.textContent = currentQuestionIndex + 1;
            
            const question = interviewQuestions[currentQuestionIndex];
            setBilingualText(currentQuestionDisplay, question.id, question.en);
            setAISpeakerStatusText("Saya akan bertanya...", "I'm about to ask a question...");
            if (talkingHead) talkingHead.classList.add('is-talking');

            finalTranscript = ""; // Reset transkrip untuk pertanyaan baru
            currentFinalTranscript = ""; // Reset juga ini
            if (transcriptDiv) setBilingualText(transcriptDiv, "Menunggu jawaban Anda...", "Waiting for your answer...");
            if (answerLengthEl) answerLengthEl.textContent = "0";
            
            resetAnalysisDisplay();
            
            if (startButton) startButton.disabled = true;
            if (stopButton) stopButton.disabled = true;
            if (nextQuestionButton) nextQuestionButton.style.display = 'none';
            if (playAnswerBtn) playAnswerBtn.disabled = true;
            if (clearTranscriptBtn) clearTranscriptBtn.disabled = true;


            let speechSynth = window.speechSynthesis;
            if (speechSynth && SpeechRecognition && currentLanguage) { // Tambahkan pengecekan currentLanguage
                speechSynth.cancel();
                
                let utterance = new SpeechSynthesisUtterance(question[currentLanguage]);
                utterance.lang = currentLanguage === 'id' ? 'id-ID' : 'en-US';
                utterance.onstart = () => {
                    setAISpeakerStatusText("Sedang bertanya...", "Asking question...");
                };
                utterance.onend = () => {
                    setAISpeakerStatusText("Silakan jawab pertanyaan ini.", "Please answer this question.");
                    if (talkingHead) talkingHead.classList.remove('is-talking');
                    if (startButton) startButton.disabled = false; // Aktifkan tombol start setelah AI selesai "berbicara"
                };
                speechSynth.speak(utterance);
            } else {
                 setTimeout(() => { // Fallback jika speech synth tidak ada
                    setAISpeakerStatusText("Silakan jawab pertanyaan ini.", "Please answer this question.");
                    if (talkingHead) talkingHead.classList.remove('is-talking');
                    if (startButton) startButton.disabled = false;
                }, 1500); 
            }
        } else {
            // Wawancara selesai
            setBilingualText(currentQuestionDisplay, "Wawancara selesai!", "Interview complete!");
            setInterviewStatusText("Selamat! Anda telah menyelesaikan semua pertanyaan.", "Congratulations! You've completed all questions.");
            if (startButton) startButton.style.display = 'none';
            if (stopButton) stopButton.style.display = 'none';
            if (nextQuestionButton) nextQuestionButton.style.display = 'none';
            if (playAnswerBtn) playAnswerBtn.disabled = true;
            if (clearTranscriptBtn) clearTranscriptBtn.disabled = true;
            setAISpeakerStatusText("Wawancara telah berakhir.", "The interview has ended.");
            if (talkingHead) talkingHead.classList.remove('is-talking');
            resetQuestionTimer();
        }
    }

    function startCurrentAnswer() { // Ganti nama fungsi
        if (!recognition) {
            setInterviewStatusText("Fitur suara tidak didukung.", "Speech feature not supported.", true);
            return;
        }
        // isInterviewActive sudah true saat displayQuestion dipanggil
        currentFinalTranscript = ""; // Bersihkan transkrip sebelum mulai jawaban baru
        if (transcriptDiv) transcriptDiv.innerHTML = ""; // Kosongkan tampilan
        if (answerLengthEl) answerLengthEl.textContent = "0";

        if (startButton) startButton.disabled = true;
        if (stopButton) stopButton.disabled = false;
        if (nextQuestionButton) nextQuestionButton.style.display = 'none';
        if (playAnswerBtn) playAnswerBtn.disabled = true;
        if (clearTranscriptBtn) clearTranscriptBtn.disabled = true;


        recognition.lang = currentLanguage === 'id' ? 'id-ID' : 'en-US';
        try {
            if (!isRecognizing) recognition.start();
        } catch (e) {
            console.warn("Error starting recognition (possibly already started):", e);
        }
        resetAnalysisDisplay(); 
        interviewInterval = setInterval(updateAnalysisData, 2500); 
        questionStartTime = Date.now(); // Mulai timer pertanyaan saat jawaban dimulai
        startQuestionTimer();
    }
    
    function stopCurrentSpeechRecognition(isEndOfQuestionFlow = true) {
        if (recognition && isRecognizing) {
            recognition.stop(); 
        }
        // isRecognizing akan di-set false di recognition.onend
        
        if (isInterviewActive) { // Hanya jika interview secara keseluruhan masih aktif
            if (talkingHead) talkingHead.classList.remove('is-talking');
            clearInterval(interviewInterval);
            resetQuestionTimer();

            if (startButton) startButton.disabled = false; 
            if (stopButton) stopButton.disabled = true;

            if (isEndOfQuestionFlow) { // Jika ini adalah bagian dari alur normal penghentian jawaban
                 setInterviewStatusText("Jawaban dihentikan. Analisis ditampilkan.", "Answer stopped. Analysis displayed.");
                 if (currentQuestionIndex < interviewQuestions.length -1 && nextQuestionButton) { // Tampilkan jika bukan pertanyaan terakhir
                    nextQuestionButton.style.display = 'inline-flex';
                 } else if (currentQuestionIndex >= interviewQuestions.length -1) { // Jika ini pertanyaan terakhir
                    // Otomatis anggap wawancara selesai
                    isInterviewActive = false;
                    displayQuestion(); // Ini akan menampilkan pesan "Wawancara Selesai"
                 }
                 updateAnalysisData(); // Tampilkan analisis final untuk jawaban ini
                 if (playAnswerBtn) playAnswerBtn.disabled = (currentFinalTranscript.trim() === "");
                 if (clearTranscriptBtn) clearTranscriptBtn.disabled = (currentFinalTranscript.trim() === "");
            }
        }
    }

    function stopCurrentAnswer() {
        stopCurrentSpeechRecognition(true); 
        if (aiSpeakerStatus) setAISpeakerStatusText("Jawaban Anda telah diterima.", "Your answer has been received.");
    }

    function handleNextQuestion() {
        currentQuestionIndex++;
        isInterviewActive = true; // Pastikan interview aktif untuk pertanyaan berikutnya
        displayQuestion();
    }

    function resetAnalysisDisplay() { /* ... (sama seperti sebelumnya) ... */ }

    function applyLanguageVisibility() { /* ... (sama seperti sebelumnya) ... */ }

    function toggleLanguage() { /* ... (sama seperti sebelumnya, pastikan memanggil applyLanguageVisibility dan mengupdate teks dinamis seperti pertanyaan) ... */ }
    
    if(clearTranscriptBtn) {
        clearTranscriptBtn.addEventListener('click', () => {
            currentFinalTranscript = "";
            if(transcriptDiv) transcriptDiv.innerHTML = "";
            if(answerLengthEl) answerLengthEl.textContent = "0";
            if(playAnswerBtn) playAnswerBtn.disabled = true;
            if(clearTranscriptBtn) clearTranscriptBtn.disabled = true;
        });
    }

    // --- Event Listeners ---
    if(startButton) startButton.addEventListener("click", startCurrentAnswer); // Ubah ke startCurrentAnswer
    if(stopButton) stopButton.addEventListener("click", stopCurrentAnswer);
    if(nextQuestionButton) nextQuestionButton.addEventListener("click", handleNextQuestion);
    if(languageSwitcher) languageSwitcher.addEventListener("click", toggleLanguage);
    
    // --- Initial Setup ---
    if (typeof setLanguage === 'function') { // Panggil dari base.html jika ada
        const preferredLang = localStorage.getItem('preferredLang') || document.documentElement.lang || 'id';
        setLanguage(preferredLang); // Ini akan set documentElement.lang dan memanggil applyLanguageVisibility versi base.html
        currentLanguage = preferredLang; // Sinkronkan currentLanguage lokal
    } else { // Fallback jika setLanguage global tidak ada
        document.documentElement.lang = currentLanguage;
        applyLanguageVisibility(); 
    }
    
    isInterviewActive = true; // Wawancara aktif saat halaman dimuat
    displayQuestion(); 
    resetAnalysisDisplay(); 
    setInterviewStatusText("Menunggu untuk memulai", "Waiting to start");
    if(aiSpeakerStatus) setAISpeakerStatusText("Selamat datang di simulasi wawancara!", "Welcome to the interview simulation!");
    setBilingualText(languageSwitcher, "Switch to English", "Ganti ke Bahasa Indonesia");

</script>
{% endblock %}