{% extends "base.html" %}

{% block title %}
    <span class="lang-id">Latihan Wawancara AI</span><span class="lang-en">AI Interview Practice</span> - {{ app_name | default('FLUENT') }}
{% endblock %}

{% block head_extra %}
    <style>
        /* Global Styles */
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
        
        .interview-simulation-container {
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            padding: 0;
            margin: 0;
        }
        
        .simulation-main-card {
            flex: 1;
            background-color: var(--fluent-background, #fff);
            box-shadow: var(--fluent-shadow-lg, 0 1rem 3rem rgba(0,0,0,.175));
            border-radius: 0;
            padding: 1.5rem;
            border: none;
            display: flex;
            flex-direction: column;
        }
        
        @media (min-width: 768px) {
            .simulation-main-card {
                padding: 2rem;
                border-radius: var(--fluent-card-radius, 0.75rem);
                margin: 1rem;
                border: 1px solid var(--fluent-border-color-soft, #eff2f5);
            }
        }

        /* Video/Camera Section */
        .video-container {
            position: relative;
            width: 100%;
            aspect-ratio: 16 / 9;
            background-color: #212529;
            border-radius: var(--fluent-border-radius, 0.5rem);
            overflow: hidden;
            margin-bottom: 1rem;
        }
        
        #cameraFeed {
            width: 100%;
            height: 100%;
            object-fit: cover;
            display: none;
        }
        
        .camera-placeholder {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            color: #ced4da;
            z-index: 1;
        }
        
        .camera-placeholder .camera-icon {
            font-size: 3.5rem;
            margin-bottom: 0.5rem;
            color: #6c757d;
        }
        
        .camera-placeholder .text {
            font-size: 1.125rem;
        }

        /* Talking Head Animation */
        .talking-head-sim {
            width: 70px;
            height: 70px;
            background-color: var(--fluent-secondary, #6c757d);
            border-radius: 50%;
            position: relative;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: 0 0 0 0 rgba(25, 135, 84, 0);
            transition: box-shadow 0.3s ease;
            margin: 0 auto;
        }
        
        .talking-head-sim.is-talking {
            animation: talk-glow-sim 1.5s infinite;
        }
        
        .talking-head-face-sim {
            width: 45px;
            height: 45px;
            background-color: #adb5bd;
            border-radius: 50%;
            position: relative;
        }
        
        .talking-head-mouth-sim {
            width: 18px;
            height: 4px;
            background-color: #212529;
            border-radius: 2px;
            position: absolute;
            bottom: 8px;
            left: 50%;
            transform: translateX(-50%);
            transition: height 0.15s ease-in-out;
        }
        
        .talking-head-sim.is-talking .talking-head-mouth-sim {
            animation: talk-mouth-sim 0.4s infinite alternate;
        }

        @keyframes talk-glow-sim {
            0% { box-shadow: 0 0 3px 1px rgba(25, 135, 84, 0.6); }
            50% { box-shadow: 0 0 15px 7px rgba(25, 135, 84, 0.25); }
            100% { box-shadow: 0 0 3px 1px rgba(25, 135, 84, 0.6); }
        }
        
        @keyframes talk-mouth-sim {
            from { height: 2px; }
            to { height: 8px; }
        }

        /* Question Display */
        .question-display-area {
            background-color: var(--fluent-light, #f8f9fa);
            padding: 1rem 1.25rem;
            border-radius: var(--fluent-border-radius, 0.5rem);
            box-shadow: var(--fluent-shadow-sm);
            border: 1px solid var(--fluent-border-color-soft, #eff2f5);
            margin-bottom: 1rem;
        }
        
        .question-display-area .question-text {
            font-weight: 600;
            font-size: 1.15rem;
            color: var(--fluent-primary, #0d6efd);
            margin-bottom: 0.5rem;
        }

        /* Transcript Area */
        .transcript-area-custom {
            min-height: 120px;
            max-height: 250px;
            overflow-y: auto;
            background-color: #fff;
            border: 1px solid var(--fluent-border-color, #dee2e6);
            border-radius: var(--fluent-border-radius);
            padding: 0.75rem 1rem;
            font-style: italic;
            color: var(--fluent-text-muted, #6c757d);
            line-height: 1.6;
        }
        
        .transcript-area-custom::-webkit-scrollbar { width: 8px; }
        .transcript-area-custom::-webkit-scrollbar-track { background: var(--fluent-light, #f8f9fa); border-radius: 10px; }
        .transcript-area-custom::-webkit-scrollbar-thumb { background: #adb5bd; border-radius: 10px; }
        .transcript-area-custom::-webkit-scrollbar-thumb:hover { background: var(--fluent-secondary, #6c757d); }
        
        .interim-transcript-custom { 
            color: var(--fluent-text-muted, #6c757d);
            opacity: 0.65;
        }

        /* Analysis Cards */
        .analysis-card-sim {
            background-color: #fff;
            padding: 1.25rem;
            border-radius: var(--fluent-border-radius);
            box-shadow: var(--fluent-shadow);
            height: 100%;
            border: 1px solid var(--fluent-border-color-soft, #eff2f5);
            margin-bottom: 1rem;
        }
        
        .analysis-card-sim h3 {
            font-size: 1.1rem;
            font-weight: 600;
            color: var(--fluent-primary, #0d6efd);
            margin-bottom: 1rem;
        }
        
        .analysis-card-sim h3 i.fas {
            font-size: 0.9em;
        }
        
        .analysis-card-sim .analysis-item p {
            font-size: 0.875rem;
            color: var(--fluent-text-muted, #6c757d);
            margin-bottom: 0.5rem;
        }
        
        .analysis-card-sim .analysis-item p .analysis-label {
            font-weight: 500;
        }
        
        .analysis-card-sim .analysis-item p .analysis-value {
            color: var(--fluent-text-dark, #212529);
            font-weight: 600;
        }

        /* Results Section */
        .results-container {
            display: none;
            margin-top: 2rem;
            padding: 1.5rem;
            background-color: #f8f9fa;
            border-radius: var(--fluent-border-radius);
            border: 1px solid var(--fluent-border-color-soft);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }
        
        .stat-card {
            background: white;
            padding: 1.25rem;
            border-radius: var(--fluent-border-radius);
            box-shadow: var(--fluent-shadow-sm);
            border: 1px solid var(--fluent-border-color-soft);
        }
        
        .recommendations {
            background: white;
            padding: 1.25rem;
            border-radius: var(--fluent-border-radius);
            box-shadow: var(--fluent-shadow-sm);
            border: 1px solid var(--fluent-border-color-soft);
            margin-top: 1.5rem;
        }
        
        .limit-message {
            display: none;
            margin-top: 2rem;
            padding: 1.5rem;
            background-color: #fff8e1;
            border-radius: var(--fluent-border-radius);
            border: 1px solid #ffecb3;
            text-align: center;
        }

        /* Recording Indicator */
        .recording-indicator-dot-sim {
            display: inline-block;
            width: 10px;
            height: 10px;
            background-color: #dc3545;
            border-radius: 50%;
            animation: pulse-sim 1.2s infinite ease-in-out;
            vertical-align: middle;
        }
        
        @keyframes pulse-sim {
            0%, 100% { opacity: 1; transform: scale(1); }
            50% { opacity: 0.4; transform: scale(0.75); }
        }
        
        /* Button Styles */
        .btn-microphone {
            position: relative;
            overflow: hidden;
        }
        
        .btn-microphone::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 5px;
            height: 5px;
            background: rgba(255, 255, 255, 0.5);
            opacity: 0;
            border-radius: 100%;
            transform: scale(1, 1) translate(-50%, -50%);
            transform-origin: 50% 50%;
        }
        
        .btn-microphone:not(:disabled):active::after {
            animation: ripple-sim 0.7s ease-out;
        }
        
        @keyframes ripple-sim {
            0% {
                transform: scale(0, 0) translate(-50%, -50%);
                opacity: 0.5;
            }
            100% {
                transform: scale(25, 25) translate(-50%, -50%);
                opacity: 0;
            }
        }
        
        /* Feedback Animations */
        .analysis-value {
            transition: color 0.3s ease, transform 0.2s ease;
            display: inline-block;
        }
        
        .positive-feedback { color: var(--bs-success, #198754) !important; }
        .neutral-feedback { color: var(--bs-warning, #ffc107) !important; }
        .negative-feedback { color: var(--bs-danger, #dc3545) !important; }
        
        .feedback-animation {
            animation: feedback-pulse-sim 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94);
        }
        
        @keyframes feedback-pulse-sim {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }
        
        /* Progress Bar */
        .progress-thin {
            height: 6px;
            border-radius: var(--fluent-border-radius);
        }
        .progress-bar {
            transition: width 0.25s ease-in-out !important;
        }

        /* Responsive Layout */
        @media (max-width: 767.98px) {
            .simulation-main-card {
                padding: 1rem;
            }
            
            .stats-grid {
                grid-template-columns: 1fr;
            }
            
            .btn-lg {
                padding: 0.5rem 1rem;
                font-size: 1rem;
            }
        }

        /* Full-height layout */
        .content-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
        }
        
        .footer-space {
            margin-top: auto;
        }
    </style>
{% endblock %}

{% block content %}
<div class="container-fluid interview-simulation-container">
    <div class="simulation-main-card">
        <div class="content-wrapper">
            <header class="mb-4 text-center">
                <h1 class="display-5 fw-bold text-primary">
                    <span class="lang-id">Latihan Wawancara AI (Simulasi)</span>
                    <span class="lang-en">AI Interview Practice (Simulation)</span>
                </h1>
                <p class="text-muted mt-2 fs-5">
                    <span class="lang-id">Jawab pertanyaan secara lisan dan dapatkan feedback instan.</span>
                    <span class="lang-en">Answer questions verbally and get instant feedback.</span>
                </p>
                <div class="mt-3">
                    <button id="languageSwitcher" class="btn btn-sm btn-outline-secondary">
                        <span class="lang-id">Switch to English</span>
                        <span class="lang-en">Ganti ke Bahasa Indonesia</span>
                    </button>
                </div>
            </header>

            <div class="main-content">
                <!-- Video/Camera Section -->
                <div class="video-container">
                    <video id="cameraFeed" autoplay playsinline></video>
                    <div class="camera-placeholder">
                        <i class="fas fa-video camera-icon"></i>
                        <div class="text">
                            <span class="lang-id">Kamera akan aktif saat memulai wawancara</span>
                            <span class="lang-en">Camera will activate when interview starts</span>
                        </div>
                    </div>
                    <div id="aiSpeakerStatus" class="position-absolute bottom-0 start-0 m-2 p-1 small rounded" style="background-color: rgba(0,0,0,0.6); color: white; z-index: 2;">
                        <span class="lang-id">AI sedang menunggu...</span>
                        <span class="lang-en">AI is waiting...</span>
                    </div>
                </div>

                <!-- Question Section -->
                <div class="question-display-area mb-3">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <p class="question-text mb-0" id="currentQuestionDisplay">
                            <span class="lang-id">Pertanyaan akan muncul di sini...</span>
                            <span class="lang-en">Question will appear here...</span>
                        </p>
                        <span class="badge bg-primary rounded-pill">
                            <span class="lang-id">Pertanyaan <span id="currentQuestionNumber">0</span>/<span id="totalQuestions">0</span></span>
                            <span class="lang-en">Question <span id="currentQuestionNumber">0</span>/<span id="totalQuestions">0</span></span>
                        </span>
                    </div>
                    <div class="progress progress-thin">
                        <div id="questionTimer" class="progress-bar bg-info progress-bar-striped progress-bar-animated" role="progressbar" style="width: 0%" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                </div>

                <!-- Transcript Section -->
                <div class="question-display-area mb-3">
                    <label for="transcript" class="form-label fw-medium mb-2">
                        <span class="lang-id">Jawaban Anda (Transkrip Suara):</span>
                        <span class="lang-en">Your Answer (Voice Transcript):</span>
                    </label>
                    <div id="transcript" class="transcript-area-custom" aria-live="polite">
                        <span class="lang-id">Tekan "Mulai Wawancara" dan izinkan akses mikrofon untuk berbicara...</span>
                        <span class="lang-en">Press "Start Interview" and allow microphone access to speak...</span>
                    </div>
                    <div class="mt-2 d-flex justify-content-between align-items-center">
                        <small class="text-muted">
                            <span class="lang-id">Panjang jawaban: <span id="answerLength" class="fw-medium">0</span> kata</span>
                            <span class="lang-en">Answer length: <span id="answerLength" class="fw-medium">0</span> words</span>
                        </small>
                        <div>
                            <button id="clearTranscriptBtn" title="Clear Transcript" class="btn btn-sm btn-outline-secondary me-2" disabled>
                                <i class="fas fa-eraser"></i>
                                <span class="visually-hidden lang-id">Hapus Transkrip</span>
                                <span class="visually-hidden lang-en">Clear Transcript</span>
                            </button>
                            <button id="playAnswerBtn" title="Play Answer" class="btn btn-sm btn-outline-primary" disabled>
                                <i class="fas fa-play"></i>
                                <span class="visually-hidden lang-id">Dengarkan Jawaban</span>
                                <span class="visually-hidden lang-en">Play Answer</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Analysis Cards -->
                <div class="row g-3 mb-3">
                    <div class="col-md-4">
                        <div class="analysis-card-sim">
                            <h3 class="h5 fw-semibold text-primary mb-3 d-flex align-items-center">
                                <i class="fas fa-smile-beam me-2 text-warning"></i>
                                <span class="lang-id">Deteksi Emosi</span><span class="lang-en">Emotion Detection</span>
                            </h3>
                            <div class="analysis-item">
                                <p><span class="analysis-label lang-id">Kondisi Emosional:</span><span class="analysis-label lang-en">Emotional State:</span> <span id="emotionState" class="analysis-value">-</span></p>
                                <p><span class="analysis-label lang-id">Tingkat Kepercayaan Diri:</span><span class="analysis-label lang-en">Confidence Level:</span> <span id="confidenceLevel" class="analysis-value">-</span></p>
                                <p><span class="analysis-label lang-id">Kegugupan:</span><span class="analysis-label lang-en">Nervousness:</span> <span id="nervousnessLevel" class="analysis-value">-</span></p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="analysis-card-sim">
                            <h3 class="h5 fw-semibold text-primary mb-3 d-flex align-items-center">
                                <i class="fas fa-bullhorn me-2 text-info"></i>
                                <span class="lang-id">Analisis Ucapan</span><span class="lang-en">Speech Analysis</span>
                            </h3>
                            <div class="analysis-item">
                                <p><span class="analysis-label lang-id">Kecepatan Bicara (KPM):</span><span class="analysis-label lang-en">Speech Rate (WPM):</span> <span id="speechRate" class="analysis-value">-</span></p>
                                <p><span class="analysis-label lang-id">Kata Pengisi:</span><span class="analysis-label lang-en">Filler Words:</span> <span id="fillerWords" class="analysis-value">-</span></p>
                                <p><span class="analysis-label lang-id">Kejelasan:</span><span class="analysis-label lang-en">Clarity:</span> <span id="speechClarity" class="analysis-value">-</span></p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4">
                        <div class="analysis-card-sim">
                            <h3 class="h5 fw-semibold text-primary mb-3 d-flex align-items-center">
                                <i class="fas fa-child me-2 text-success"></i>
                                <span class="lang-id">Analisis Bahasa Tubuh</span><span class="lang-en">Body Language Analysis</span>
                            </h3>
                            <div class="analysis-item">
                                <p><span class="analysis-label lang-id">Postur:</span><span class="analysis-label lang-en">Posture:</span> <span id="postureDisplay" class="analysis-value">-</span></p>
                                <p><span class="analysis-label lang-id">Kontak Mata:</span><span class="analysis-label lang-en">Eye Contact:</span> <span id="eyeContact" class="analysis-value">-</span></p>
                                <p><span class="analysis-label lang-id">Gestur Tangan:</span><span class="analysis-label lang-en">Hand Gestures:</span> <span id="handGestures" class="analysis-value">-</span></p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Results Section -->
                <div id="resultsContainer" class="results-container">
                    <h2 class="text-center mb-4">
                        <span class="lang-id">Hasil Wawancara Anda</span>
                        <span class="lang-en">Your Interview Results</span>
                    </h2>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <h4><i class="fas fa-chart-line me-2 text-primary"></i> <span class="lang-id">Statistik Keseluruhan</span><span class="lang-en">Overall Statistics</span></h4>
                            <canvas id="overallChart" height="200"></canvas>
                        </div>
                        
                        <div class="stat-card">
                            <h4><i class="fas fa-star me-2 text-warning"></i> <span class="lang-id">Kekuatan</span><span class="lang-en">Strengths</span></h4>
                            <ul id="strengthsList" class="list-group list-group-flush">
                                <!-- Will be populated by JS -->
                            </ul>
                        </div>
                        
                        <div class="stat-card">
                            <h4><i class="fas fa-exclamation-triangle me-2 text-danger"></i> <span class="lang-id">Perlu Perbaikan</span><span class="lang-en">Areas to Improve</span></h4>
                            <ul id="improvementsList" class="list-group list-group-flush">
                                <!-- Will be populated by JS -->
                            </ul>
                        </div>
                    </div>
                    
                    <div class="recommendations">
                        <h4><i class="fas fa-lightbulb me-2 text-info"></i> <span class="lang-id">Rekomendasi</span><span class="lang-en">Recommendations</span></h4>
                        <div id="recommendationsContent">
                            <!-- Will be populated by JS -->
                        </div>
                    </div>
                    
                    <div class="text-center mt-4">
                        <button id="downloadReportBtn" class="btn btn-primary me-2">
                            <i class="fas fa-download me-1"></i>
                            <span class="lang-id">Unduh Laporan</span>
                            <span class="lang-en">Download Report</span>
                        </button>
                        <button id="tryAgainBtn" class="btn btn-outline-secondary">
                            <i class="fas fa-redo me-1"></i>
                            <span class="lang-id">Coba Lagi</span>
                            <span class="lang-en">Try Again</span>
                        </button>
                    </div>
                </div>

                <!-- Limit Message -->
                <div id="limitMessage" class="limit-message">
                    <h4><i class="fas fa-exclamation-circle me-2 text-warning"></i> 
                        <span class="lang-id">Anda telah mencapai batas percobaan</span>
                        <span class="lang-en">You've reached the trial limit</span>
                    </h4>
                    <p class="mb-3">
                        <span class="lang-id">Untuk pengalaman lebih lengkap, silakan unduh aplikasi FLUENT di perangkat mobile Anda.</span>
                        <span class="lang-en">For the full experience, please download the FLUENT app on your mobile device.</span>
                    </p>
                    <div>
                        <a href="#" class="btn btn-success me-2">
                            <i class="fab fa-google-play me-1"></i>
                            <span class="lang-id">Download di Play Store</span>
                            <span class="lang-en">Download on Play Store</span>
                        </a>
                        <a href="#" class="btn btn-dark">
                            <i class="fab fa-apple me-1"></i>
                            <span class="lang-id">Download di App Store</span>
                            <span class="lang-en">Download on App Store</span>
                        </a>
                    </div>
                </div>

                <!-- Control Buttons -->
                <div class="d-grid gap-2 d-sm-flex justify-content-sm-center mt-auto pt-3">
                    <button id="startButton" class="btn btn-primary btn-lg flex-grow-1 flex-sm-grow-0 btn-microphone">
                        <i class="fas fa-microphone-alt me-2"></i>
                        <span class="lang-id">Mulai Menjawab</span>
                        <span class="lang-en">Start Answering</span>
                    </button>
                    <button id="stopButton" class="btn btn-danger btn-lg flex-grow-1 flex-sm-grow-0" disabled>
                        <i class="fas fa-stop-circle me-2"></i>
                        <span class="lang-id">Hentikan Jawaban</span>
                        <span class="lang-en">Stop Answer</span>
                    </button>
                    <button id="nextQuestionButton" class="btn btn-success btn-lg flex-grow-1 flex-sm-grow-0" style="display: none;">
                        <i class="fas fa-arrow-right me-2"></i>
                        <span class="lang-id">Pertanyaan Berikutnya</span>
                        <span class="lang-en">Next Question</span>
                    </button>
                </div>
                <p id="interviewStatus" class="text-center text-muted small mt-3">
                    <span class="lang-id">Status: Menunggu untuk memulai</span>
                    <span class="lang-en">Status: Waiting to start</span>
                    <span id="recordingIndicator" class="recording-indicator-dot-sim ms-2" style="display: none;"></span>
                </p>
            </div>

            <footer class="mt-5 pt-4 border-top text-center small text-muted footer-space">
                <p>&copy; <span id="currentYear"></span> {{ app_name | default('Simulasi Latihan Wawancara AI') }}.
                    <span class="lang-id">Hanya untuk tujuan demonstrasi.</span>
                    <span class="lang-en">For demonstration purposes only.</span>
                </p>
                <p>
                    <span class="lang-id">Tidak ada data video/audio yang direkam atau dianalisis secara nyata.</span>
                    <span class="lang-en">No video/audio data is actually recorded or analyzed.</span>
                </p>
                <p class="mt-3">
                    <a href="{{ url_for('web.web_profile_route') }}" id="backToProfileLink" class="btn btn-sm btn-outline-secondary">
                        <i class="fas fa-arrow-left me-1"></i>
                        <span class="lang-id">Kembali ke Profil</span>
                        <span class="lang-en">Back to Profile</span>
                    </a>
                </p>
            </footer>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts_extra %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
    // --- DOM Elements ---
    const cameraFeed = document.getElementById("cameraFeed");
    const cameraPlaceholder = document.querySelector(".camera-placeholder");
    const resultsContainer = document.getElementById("resultsContainer");
    const limitMessage = document.getElementById("limitMessage");
    const tryAgainBtn = document.getElementById("tryAgainBtn");
    const downloadReportBtn = document.getElementById("downloadReportBtn");
    const startButton = document.getElementById("startButton");
    const stopButton = document.getElementById("stopButton");
    const nextQuestionButton = document.getElementById("nextQuestionButton");
    const interviewStatus = document.getElementById("interviewStatus");
    const transcriptDiv = document.getElementById("transcript");
    const recordingIndicator = document.getElementById("recordingIndicator");
    const currentQuestionDisplay = document.getElementById("currentQuestionDisplay");
    const languageSwitcher = document.getElementById("languageSwitcher");
    const aiSpeakerStatus = document.getElementById("aiSpeakerStatus");
    const talkingHead = document.getElementById("talkingHead");
    const clearTranscriptBtn = document.getElementById("clearTranscriptBtn");
    const playAnswerBtn = document.getElementById("playAnswerBtn");
    const answerLengthEl = document.getElementById("answerLength");
    const currentQuestionNumberEl = document.getElementById("currentQuestionNumber");
    const totalQuestionsEl = document.getElementById("totalQuestions");
    const questionTimerEl = document.getElementById("questionTimer");
    const emotionState = document.getElementById("emotionState");
    const confidenceLevel = document.getElementById("confidenceLevel");
    const nervousnessLevel = document.getElementById("nervousnessLevel");
    const speechRate = document.getElementById("speechRate");
    const fillerWords = document.getElementById("fillerWords");
    const speechClarity = document.getElementById("speechClarity");
    const postureDisplay = document.getElementById("postureDisplay");
    const eyeContact = document.getElementById("eyeContact");
    const handGestures = document.getElementById("handGestures");

    // --- State Variables ---
    let cameraStream = null;
    let interviewAttempts = 0;
    const MAX_ATTEMPTS = 3;
    let interviewInterval;
    let isInterviewActive = false;
    let isRecognizing = false;
    let currentQuestionIndex = 0;
    let currentLanguage = localStorage.getItem('preferredLang') || document.documentElement.lang || 'id';
    let questionStartTime;
    let timerInterval;
    let currentFinalTranscript = "";
    let audioContext;
    let audioBufferForPlayback;
    let isPlayingAudio = false;
    let audioSourceNode;

    const QUESTION_TIME_LIMIT = 60; // Seconds per question

    // Interview questions data
    const interviewQuestions = [
        { id: "Ceritakan tentang diri Anda.", en: "Tell me about yourself." },
        { id: "Apa kekuatan terbesar Anda?", en: "What is your greatest strength?" },
        { id: "Apa kelemahan terbesar Anda?", en: "What is your greatest weakness?" },
        { id: "Di mana Anda melihat diri Anda dalam 5 tahun ke depan?", en: "Where do you see yourself in 5 years?" },
        { id: "Mengapa Anda tertarik dengan posisi ini?", en: "Why are you interested in this position?" },
        { id: "Mengapa kami harus mempekerjakan Anda?", en: "Why should we hire you?" }
    ];
    
    // Analysis simulation data
    const emotions = [
        { value: "Positif", class: "positive-feedback" },
        { value: "Netral", class: "neutral-feedback" },
        { value: "Gugup", class: "negative-feedback" },
        { value: "Percaya Diri", class: "positive-feedback" },
        { value: "Antusias", class: "positive-feedback" }
    ];
    
    const speechRatesData = [
        { value: "Cepat (180 KPM)", class: "neutral-feedback" },
        { value: "Sedang (150 KPM)", class: "positive-feedback" },
        { value: "Lambat (120 KPM)", class: "neutral-feedback" },
        { value: "Sangat Cepat (200 KPM)", class: "negative-feedback" },
        { value: "Sangat Lambat (100 KPM)", class: "negative-feedback" }
    ];
    
    const fillerWordsData = [
        { value: "Rendah (5%)", class: "positive-feedback" },
        { value: "Sedang (15%)", class: "neutral-feedback" },
        { value: "Tinggi (30%)", class: "negative-feedback" },
        { value: "Sangat Rendah (2%)", class: "positive-feedback" },
        { value: "Sangat Tinggi (50%)", class: "negative-feedback" }
    ];
    
    const claritiesData = [
        { value: "Jelas", class: "positive-feedback" },
        { value: "Sedang", class: "neutral-feedback" },
        { value: "Kurang Jelas", class: "negative-feedback" },
        { value: "Sangat Jelas", class: "positive-feedback" },
        { value: "Sangat Tidak Jelas", class: "negative-feedback" }
    ];
    
    const posturesData = [
        { value: "Tegak", class: "positive-feedback" },
        { value: "Sedikit Membungkuk", class: "neutral-feedback" },
        { value: "Membungkuk", class: "negative-feedback" },
        { value: "Sangat Tegak", class: "positive-feedback" },
        { value: "Sangat Membungkuk", class: "negative-feedback" }
    ];
    
    const eyeContactsData = [
        { value: "Baik", class: "positive-feedback" },
        { value: "Sedang", class: "neutral-feedback" },
        { value: "Buruk", class: "negative-feedback" },
        { value: "Sangat Baik", class: "positive-feedback" },
        { value: "Sangat Buruk", class: "negative-feedback" }
    ];
    
    const handGesturesData = [
        { value: "Alami", class: "positive-feedback" },
        { value: "Sedikit Kaku", class: "neutral-feedback" },
        { value: "Kaku", class: "negative-feedback" },
        { value: "Sangat Alami", class: "positive-feedback" },
        { value: "Sangat Kaku", class: "negative-feedback" }
    ];

    // --- Speech Recognition Setup ---
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    let recognition;

    if (SpeechRecognition) {
        recognition = new SpeechRecognition();
        recognition.continuous = true;
        recognition.interimResults = true;

        recognition.onstart = function() {
            console.log("Speech recognition has started.");
            isRecognizing = true;
            if (recordingIndicator) recordingIndicator.style.display = "inline-block";
            setInterviewStatusText("Mendengarkan...", "Listening...");
            if (talkingHead) talkingHead.classList.add('is-talking');
            if (aiSpeakerStatus) setAISpeakerStatusText("Saya mendengarkan jawaban Anda...", "I'm listening to your answer...");
        };

        recognition.onresult = function(event) {
            let interim_transcript = "";
            let final_transcript_segment = "";

            for (let i = event.resultIndex; i < event.results.length; ++i) {
                if (event.results[i].isFinal) {
                    final_transcript_segment += event.results[i][0].transcript + ' ';
                } else {
                    interim_transcript += event.results[i][0].transcript;
                }
            }
            
            if (final_transcript_segment) {
                currentFinalTranscript += final_transcript_segment;
                if (playAnswerBtn) playAnswerBtn.disabled = false;
                if (clearTranscriptBtn) clearTranscriptBtn.disabled = false;
            }

            if (transcriptDiv) {
                transcriptDiv.innerHTML = `<span class="interim-transcript-custom">${interim_transcript}</span>${currentFinalTranscript}`;
                transcriptDiv.scrollTop = transcriptDiv.scrollHeight;
                
                const wordCount = currentFinalTranscript.trim() === "" ? 0 : currentFinalTranscript.trim().split(/\s+/).length;
                if(answerLengthEl) answerLengthEl.textContent = wordCount;
            }
        };

        recognition.onerror = function(event) {
            console.error("Speech recognition error:", event.error);
            let errorMessageId = "Terjadi kesalahan pada pengenalan suara.";
            let errorMessageEn = "Speech recognition error.";
            
            if (event.error === "no-speech") {
                errorMessageId = "Tidak terdeteksi suara. Pastikan mikrofon berfungsi.";
                errorMessageEn = "No speech detected. Please check your microphone.";
            } else if (event.error === "audio-capture") {
                errorMessageId = "Tidak dapat mengakses mikrofon. Pastikan izin diberikan.";
                errorMessageEn = "Microphone access denied. Please check permissions.";
            } else if (event.error === "not-allowed") {
                errorMessageId = "Akses mikrofon diblokir. Harap berikan izin.";
                errorMessageEn = "Microphone access blocked. Please allow permissions.";
            }

            setInterviewStatusText(errorMessageId, errorMessageEn, true);
            stopCurrentSpeechRecognition(false);
            if (talkingHead) talkingHead.classList.remove('is-talking');
            if (aiSpeakerStatus) setAISpeakerStatusText("Ada masalah dengan mikrofon.", "There was an issue with the microphone.");
            resetQuestionTimer();
        };

        recognition.onend = function() {
            console.log("Speech recognition has ended.");
            isRecognizing = false;
            if (recordingIndicator) recordingIndicator.style.display = "none";
            if (talkingHead) talkingHead.classList.remove('is-talking');
            
            if (isInterviewActive && startButton && startButton.disabled) {
                setInterviewStatusText(
                    "Perekaman suara berhenti. Tekan 'Mulai' untuk lanjut atau 'Hentikan Jawaban'.",
                    "Voice recording stopped. Press 'Start' to continue or 'Stop Answer'."
                );
            }
        };
    } else {
        console.warn("Speech recognition not supported in this browser.");
        if (startButton) startButton.disabled = true;
        setInterviewStatusText(
            "Browser tidak mendukung pengenalan suara. Gunakan Chrome atau Edge.",
            "Browser doesn't support speech recognition. Please use Chrome or Edge.",
            true
        );
    }

    // --- Helper Functions ---
    function getRandomElement(arr) {
        return arr[Math.floor(Math.random() * arr.length)];
    }

    function applyFeedbackClass(element, feedbackType) {
        if (!element) return;
        
        // Remove all feedback classes first
        element.classList.remove("positive-feedback", "neutral-feedback", "negative-feedback", "feedback-animation");
        
        // Add the appropriate class
        if (feedbackType) {
            element.classList.add(feedbackType.class, "feedback-animation");
        }
        
        return feedbackType ? feedbackType.value : "-";
    }

    function updateAnalysisData() {
        if (!isInterviewActive) return;
        
        const emotion = getRandomElement(emotions);
        const speechRateData = getRandomElement(speechRatesData);
        const fillerWord = getRandomElement(fillerWordsData);
        const clarity = getRandomElement(claritiesData);
        const posture = getRandomElement(posturesData);
        const eyeContactData = getRandomElement(eyeContactsData);
        const handGesture = getRandomElement(handGesturesData);
        
        if (emotionState) emotionState.textContent = applyFeedbackClass(emotionState, emotion);
        if (confidenceLevel) confidenceLevel.textContent = applyFeedbackClass(confidenceLevel, getRandomElement(emotions.filter(e => e.class !== "negative-feedback")));
        if (nervousnessLevel) nervousnessLevel.textContent = applyFeedbackClass(nervousnessLevel, getRandomElement(emotions.filter(e => e.class === "negative-feedback")));
        if (speechRate) speechRate.textContent = applyFeedbackClass(speechRate, speechRateData);
        if (fillerWords) fillerWords.textContent = applyFeedbackClass(fillerWords, fillerWord);
        if (speechClarity) speechClarity.textContent = applyFeedbackClass(speechClarity, clarity);
        if (postureDisplay) postureDisplay.textContent = applyFeedbackClass(postureDisplay, posture);
        if (eyeContact) eyeContact.textContent = applyFeedbackClass(eyeContact, eyeContactData);
        if (handGestures) handGestures.textContent = applyFeedbackClass(handGestures, handGesture);
    }

    function setBilingualText(element, textId, textEn) {
        if (!element) return;
        
        const idSpan = element.querySelector('.lang-id');
        const enSpan = element.querySelector('.lang-en');
        
        if (idSpan && enSpan) {
            idSpan.textContent = textId;
            enSpan.textContent = textEn;
        } else {
            // For elements that don't have the spans (like simple text elements)
            element.textContent = currentLanguage === 'id' ? textId : textEn;
        }
    }
    
    function setInterviewStatusText(textId, textEn, isError = false) {
        if (!interviewStatus) return;
        
        const idSpan = interviewStatus.querySelector('.lang-id');
        const enSpan = interviewStatus.querySelector('.lang-en');
        
        if (idSpan && enSpan) {
            idSpan.textContent = textId;
            enSpan.textContent = textEn;
        }
        
        if (isError) {
            interviewStatus.classList.add('text-danger');
        } else {
            interviewStatus.classList.remove('text-danger');
        }
    }
    
    function setAISpeakerStatusText(textId, textEn) {
        if (!aiSpeakerStatus) return;
        
        const idSpan = aiSpeakerStatus.querySelector('.lang-id');
        const enSpan = aiSpeakerStatus.querySelector('.lang-en');
        
        if (idSpan && enSpan) {
            idSpan.textContent = textId;
            enSpan.textContent = textEn;
        }
    }

    function startQuestionTimer() {
        clearInterval(timerInterval);
        let timeLeft = QUESTION_TIME_LIMIT;
        if (questionTimerEl) {
            questionTimerEl.style.width = "100%";
            questionTimerEl.classList.remove('bg-danger', 'bg-warning');
            questionTimerEl.classList.add('bg-info');
        }

        timerInterval = setInterval(() => {
            timeLeft--;
            const percentage = (timeLeft / QUESTION_TIME_LIMIT) * 100;
            if (questionTimerEl) questionTimerEl.style.width = percentage + "%";

            if (percentage < 25) {
                if (questionTimerEl) questionTimerEl.classList.replace('bg-info', 'bg-danger');
            } else if (percentage < 50) {
                if (questionTimerEl) questionTimerEl.classList.replace('bg-info', 'bg-warning');
            }

            if (timeLeft <= 0) {
                clearInterval(timerInterval);
                setInterviewStatusText("Waktu habis untuk pertanyaan ini!", "Time's up for this question!");
                stopCurrentAnswer();
            }
        }, 1000);
    }

    function resetQuestionTimer() {
        clearInterval(timerInterval);
        if (questionTimerEl) {
            questionTimerEl.style.width = "0%";
            questionTimerEl.classList.remove('bg-danger', 'bg-warning');
            questionTimerEl.classList.add('bg-info');
        }
    }
    
    function displayQuestion() {
        resetQuestionTimer();
        if (currentQuestionIndex < interviewQuestions.length) {
            if(currentQuestionNumberEl) currentQuestionNumberEl.textContent = currentQuestionIndex + 1;
            if(totalQuestionsEl) totalQuestionsEl.textContent = interviewQuestions.length;
            
            const question = interviewQuestions[currentQuestionIndex];
            setBilingualText(currentQuestionDisplay, question.id, question.en);
            setAISpeakerStatusText("Saya akan bertanya...", "I'm about to ask a question...");
            if (talkingHead) talkingHead.classList.add('is-talking');

            currentFinalTranscript = "";
            if (transcriptDiv) setBilingualText(transcriptDiv, "Menunggu jawaban Anda...", "Waiting for your answer...");
            if (answerLengthEl) answerLengthEl.textContent = "0";
            
            resetAnalysisDisplay();
            
            if (startButton) startButton.disabled = true;
            if (stopButton) stopButton.disabled = true;
            if (nextQuestionButton) nextQuestionButton.style.display = 'none';
            if (playAnswerBtn) playAnswerBtn.disabled = true;
            if (clearTranscriptBtn) clearTranscriptBtn.disabled = true;

            let speechSynth = window.speechSynthesis;
            if (speechSynth && SpeechRecognition && currentLanguage) {
                speechSynth.cancel();
                
                let utterance = new SpeechSynthesisUtterance(question[currentLanguage]);
                utterance.lang = currentLanguage === 'id' ? 'id-ID' : 'en-US';
                utterance.onstart = () => {
                    setAISpeakerStatusText("Sedang bertanya...", "Asking question...");
                };
                utterance.onend = () => {
                    setAISpeakerStatusText("Silakan jawab pertanyaan ini.", "Please answer this question.");
                    if (talkingHead) talkingHead.classList.remove('is-talking');
                    if (startButton) startButton.disabled = false;
                };
                speechSynth.speak(utterance);
            } else {
                setTimeout(() => {
                    setAISpeakerStatusText("Silakan jawab pertanyaan ini.", "Please answer this question.");
                    if (talkingHead) talkingHead.classList.remove('is-talking');
                    if (startButton) startButton.disabled = false;
                }, 1500); 
            }
        } else {
            setBilingualText(currentQuestionDisplay, "Wawancara selesai!", "Interview complete!");
            setInterviewStatusText("Selamat! Anda telah menyelesaikan semua pertanyaan.", "Congratulations! You've completed all questions.");
            if (startButton) startButton.style.display = 'none';
            if (stopButton) stopButton.style.display = 'none';
            if (nextQuestionButton) nextQuestionButton.style.display = 'none';
            if (playAnswerBtn) playAnswerBtn.disabled = true;
            if (clearTranscriptBtn) clearTranscriptBtn.disabled = true;
            setAISpeakerStatusText("Wawancara telah berakhir.", "The interview has ended.");
            if (talkingHead) talkingHead.classList.remove('is-talking');
            resetQuestionTimer();
        }
    }

    async function startCurrentAnswer() {
        if (!recognition) {
            setInterviewStatusText("Fitur suara tidak didukung.", "Speech feature not supported.", true);
            return;
        }

        // Start camera
        await startCamera();
        
        currentFinalTranscript = "";
        if (transcriptDiv) transcriptDiv.innerHTML = "";
        if (answerLengthEl) answerLengthEl.textContent = "0";

        if (startButton) startButton.disabled = true;
        if (stopButton) stopButton.disabled = false;
        if (nextQuestionButton) nextQuestionButton.style.display = 'none';
        if (playAnswerBtn) playAnswerBtn.disabled = true;
        if (clearTranscriptBtn) clearTranscriptBtn.disabled = true;

        recognition.lang = currentLanguage === 'id' ? 'id-ID' : 'en-US';
        try {
            if (!isRecognizing) recognition.start();
        } catch (e) {
            console.warn("Error starting recognition:", e);
        }
        resetAnalysisDisplay(); 
        interviewInterval = setInterval(updateAnalysisData, 2500); 
        questionStartTime = Date.now();
        startQuestionTimer();
    }
    
    function stopCurrentSpeechRecognition(isEndOfQuestionFlow = true) {
        if (recognition && isRecognizing) {
            recognition.stop(); 
        }
        
        if (isInterviewActive) {
            if (talkingHead) talkingHead.classList.remove('is-talking');
            clearInterval(interviewInterval);
            resetQuestionTimer();

            if (startButton) startButton.disabled = false; 
            if (stopButton) stopButton.disabled = true;

            if (isEndOfQuestionFlow) {
                setInterviewStatusText("Jawaban dihentikan. Analisis ditampilkan.", "Answer stopped. Analysis displayed.");
                if (currentQuestionIndex < interviewQuestions.length -1 && nextQuestionButton) {
                    nextQuestionButton.style.display = 'inline-flex';
                } else if (currentQuestionIndex >= interviewQuestions.length -1) {
                    isInterviewActive = false;
                    setTimeout(showResults, 1500);
                }
                updateAnalysisData();
                if (playAnswerBtn) playAnswerBtn.disabled = (currentFinalTranscript.trim() === "");
                if (clearTranscriptBtn) clearTranscriptBtn.disabled = (currentFinalTranscript.trim() === "");
            }
        }
    }

    function stopCurrentAnswer() {
        stopCurrentSpeechRecognition(true); 
        stopCamera();
        if (aiSpeakerStatus) setAISpeakerStatusText("Jawaban Anda telah diterima.", "Your answer has been received.");
    }

    function handleNextQuestion() {
        currentQuestionIndex++;
        isInterviewActive = true;
        displayQuestion();
    }

    function resetAnalysisDisplay() {
        const resetValue = "-";
        const elements = [
            emotionState, confidenceLevel, nervousnessLevel, 
            speechRate, fillerWords, speechClarity,
            postureDisplay, eyeContact, handGestures
        ];
        
        elements.forEach(el => {
            if (el) {
                el.textContent = resetValue;
                el.className = "analysis-value";
            }
        });
    }

    function applyLanguageVisibility() {
        document.querySelectorAll('.lang-id, .lang-en').forEach(el => {
            el.style.display = 'none';
        });
        
        const langElements = document.querySelectorAll(`.lang-${currentLanguage}`);
        langElements.forEach(el => {
            el.style.display = 'inline';
        });
    }

    function toggleLanguage() {
        currentLanguage = currentLanguage === 'id' ? 'en' : 'id';
        localStorage.setItem('preferredLang', currentLanguage);
        document.documentElement.lang = currentLanguage;
        
        applyLanguageVisibility();
        
        setBilingualText(languageSwitcher, "Switch to English", "Ganti ke Bahasa Indonesia");
        
        if (isInterviewActive) {
            displayQuestion();
        }
    }

    // --- Camera Functions ---
    async function startCamera() {
        try {
            cameraStream = await navigator.mediaDevices.getUserMedia({ 
                video: true,
                audio: false
            });
            cameraFeed.srcObject = cameraStream;
            cameraFeed.style.display = "block";
            cameraPlaceholder.style.display = "none";
            return true;
        } catch (err) {
            console.error("Error accessing camera:", err);
            setInterviewStatusText(
                "Tidak dapat mengakses kamera. Fitur analisis bahasa tubuh mungkin tidak akurat.",
                "Could not access camera. Body language analysis may be less accurate.",
                true
            );
            return false;
        }
    }

    function stopCamera() {
        if (cameraStream) {
            cameraStream.getTracks().forEach(track => track.stop());
            cameraFeed.style.display = "none";
            cameraPlaceholder.style.display = "flex";
        }
    }

    // --- Results Functions ---
    function showResults() {
        // Generate random results for demonstration
        const overallScore = Math.floor(Math.random() * 40) + 60; // 60-100
        const emotionScore = Math.floor(Math.random() * 20) + 70;
        const speechScore = Math.floor(Math.random() * 20) + 65;
        const bodyLangScore = Math.floor(Math.random() * 30) + 60;
        
        // Update chart
        renderOverallChart(overallScore, emotionScore, speechScore, bodyLangScore);
        
        // Generate strengths
        const strengths = [
            { id: "Kepercayaan diri yang baik", en: "Good confidence level" },
            { id: "Kecepatan bicara yang tepat", en: "Appropriate speech rate" },
            { id: "Postur tubuh yang baik", en: "Good posture" },
            { id: "Ekspresi wajah yang sesuai", en: "Appropriate facial expressions" },
            { id: "Jawaban terstruktur dengan baik", en: "Well-structured answers" }
        ].slice(0, Math.floor(Math.random() * 2) + 2); // 2-3 strengths
        
        // Generate areas to improve
        const improvements = [
            { id: "Kurangi kata pengisi seperti 'eee', 'mmm'", en: "Reduce filler words like 'um', 'ah'" },
            { id: "Tingkatkan kontak mata", en: "Improve eye contact" },
            { id: "Kurangi kegugupan", en: "Reduce nervousness" },
            { id: "Perbaiki kejelasan pengucapan", en: "Improve speech clarity" },
            { id: "Gunakan lebih banyak contoh konkret", en: "Use more concrete examples" }
        ].slice(0, Math.floor(Math.random() * 2) + 2); // 2-3 improvements
        
        // Generate recommendations
        const recommendations = [
            { id: "Berlatihlah menjawab pertanyaan umum wawancara di depan cermin", en: "Practice answering common interview questions in front of a mirror" },
            { id: "Rekam diri Anda saat berlatih dan evaluasi performa", en: "Record yourself practicing and evaluate your performance" },
            { id: "Ambil napas dalam sebelum menjawab untuk mengurangi kegugupan", en: "Take deep breaths before answering to reduce nervousness" },
            { id: "Persiapkan cerita pencapaian profesional yang relevan", en: "Prepare relevant professional achievement stories" },
            { id: "Latih kontak mata dengan berbicara kepada teman atau keluarga", en: "Practice eye contact by speaking to friends or family" }
        ];
        
        // Populate results
        const strengthsList = document.getElementById("strengthsList");
        strengthsList.innerHTML = strengths.map(item => 
            `<li class="list-group-item"><i class="fas fa-check-circle text-success me-2"></i>${currentLanguage === 'id' ? item.id : item.en}</li>`
        ).join("");
        
        const improvementsList = document.getElementById("improvementsList");
        improvementsList.innerHTML = improvements.map(item => 
            `<li class="list-group-item"><i class="fas fa-exclamation-circle text-warning me-2"></i>${currentLanguage === 'id' ? item.id : item.en}</li>`
        ).join("");
        
        const recommendationsContent = document.getElementById("recommendationsContent");
        recommendationsContent.innerHTML = recommendations.map(item => 
            `<p><i class="fas fa-arrow-right text-info me-2"></i>${currentLanguage === 'id' ? item.id : item.en}</p>`
        ).join("");
        
        // Show results
        resultsContainer.style.display = "block";
        
        // Check if reached attempt limit
        interviewAttempts++;
        if (interviewAttempts >= MAX_ATTEMPTS) {
            limitMessage.style.display = "block";
            if (tryAgainBtn) tryAgainBtn.disabled = true;
        }
    }

    function renderOverallChart(overall, emotion, speech, bodyLang) {
        const ctx = document.getElementById('overallChart').getContext('2d');
        new Chart(ctx, {
            type: 'radar',
            data: {
                labels: [
                    currentLanguage === 'id' ? 'Keseluruhan' : 'Overall',
                    currentLanguage === 'id' ? 'Emosi' : 'Emotion',
                    currentLanguage === 'id' ? 'Ucapan' : 'Speech',
                    currentLanguage === 'id' ? 'Bahasa Tubuh' : 'Body Language'
                ],
                datasets: [{
                    label: currentLanguage === 'id' ? 'Skor Anda' : 'Your Score',
                    data: [overall, emotion, speech, bodyLang],
                    backgroundColor: 'rgba(13, 110, 253, 0.2)',
                    borderColor: 'rgba(13, 110, 253, 1)',
                    borderWidth: 2,
                    pointBackgroundColor: 'rgba(13, 110, 253, 1)'
                }]
            },
            options: {
                scales: {
                    r: {
                        angleLines: { display: true },
                        suggestedMin: 0,
                        suggestedMax: 100
                    }
                }
            }
        });
    }

    function resetInterview() {
        currentQuestionIndex = 0;
        currentFinalTranscript = "";
        resetAnalysisDisplay();
        resetQuestionTimer();
        resultsContainer.style.display = "none";
        limitMessage.style.display = "none";
        if (tryAgainBtn) tryAgainBtn.disabled = false;
        displayQuestion();
    }

    // --- Event Listeners ---
    if (startButton) startButton.addEventListener("click", startCurrentAnswer);
    if (stopButton) stopButton.addEventListener("click", stopCurrentAnswer);
    if (nextQuestionButton) nextQuestionButton.addEventListener("click", handleNextQuestion);
    if (languageSwitcher) languageSwitcher.addEventListener("click", toggleLanguage);
    if (tryAgainBtn) tryAgainBtn.addEventListener("click", resetInterview);
    
    if (downloadReportBtn) {
        downloadReportBtn.addEventListener("click", function() {
            alert(currentLanguage === 'id' ? 
                "Laporan akan diunduh (simulasi)" : 
                "Report will be downloaded (simulation)");
        });
    }
    
    if(clearTranscriptBtn) {
        clearTranscriptBtn.addEventListener('click', () => {
            currentFinalTranscript = "";
            if(transcriptDiv) transcriptDiv.innerHTML = "";
            if(answerLengthEl) answerLengthEl.textContent = "0";
            if(playAnswerBtn) playAnswerBtn.disabled = true;
            if(clearTranscriptBtn) clearTranscriptBtn.disabled = true;
        });
    }

    // --- Initial Setup ---
    document.getElementById("currentYear").textContent = new Date().getFullYear();
    
    // Initialize with preferred language
    if (typeof setLanguage === 'function') {
        const preferredLang = localStorage.getItem('preferredLang') || document.documentElement.lang || 'id';
        setLanguage(preferredLang);
        currentLanguage = preferredLang;
    } else {
        document.documentElement.lang = currentLanguage;
        applyLanguageVisibility(); 
    }
    
    isInterviewActive = true;
    displayQuestion(); 
    resetAnalysisDisplay(); 
    setInterviewStatusText("Menunggu untuk memulai", "Waiting to start");
    if(aiSpeakerStatus) setAISpeakerStatusText("Selamat datang di simulasi wawancara!", "Welcome to the interview simulation!");
    setBilingualText(languageSwitcher, "Switch to English", "Ganti ke Bahasa Indonesia");
</script>
{% endblock %}