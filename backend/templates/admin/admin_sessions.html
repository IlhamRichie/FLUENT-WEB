{% extends "base.html" %}
{% block title %}Interview Sessions - Admin{% endblock %}
{% block content %}
<div class="container-fluid py-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h2 fw-bold">Interview Sessions</h1>
        <!-- UBAH INI -->
        <a href="{{ url_for('admin.admin_dashboard_route') }}" class="btn btn-outline-primary">
            <i class="bi bi-arrow-left"></i> Back to Dashboard
        </a>
    </div>

    <!-- Form Pencarian -->
    <form method="GET" action="{{ url_for('admin.admin_sessions_route') }}" class="mb-4">
        <div class="input-group">
            <input type="text" name="search_email" class="form-control" placeholder="Search by User Email..." value="{{ search_email or '' }}">
            <button class="btn btn-primary" type="submit"><i class="bi bi-search"></i> Search</button>
            {% if search_email %}
                <a href="{{ url_for('admin.admin_sessions_route') }}" class="btn btn-outline-secondary">Clear</a>
            {% endif %}
        </div>
    </form>

    <!-- Sessions Table -->
    <div class="card border-0 shadow-sm">
        <div class="card-header bg-white border-0 py-3">
            <h3 class="h5 mb-0 fw-bold">All Interview Sessions</h3>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover align-middle mb-0">
                    <thead class="table-light">
                        <tr>
                            <th class="ps-3">#</th>
                            <th>User Email</th>
                            <th>Username</th>
                            <th>Category</th>
                            <th>Start Time (UTC)</th>
                            <th>End Time (UTC)</th>
                            <th>Status</th>
                            <th>Score</th>
                            <th class="pe-3 text-end">Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% if sessions and sessions|length > 0 %}
                        {% for session_doc in sessions %} <!-- Nama variabel diubah agar konsisten dengan backend -->
                        <tr>
                            <td class="ps-3">{{ loop.index + ( (page - 1) * 10 ) }}</td> <!-- Nomor urut dengan pagination -->
                            <td>{{ session_doc.user_email }}</td>
                            <td>
                                <div class="d-flex align-items-center">
                                    <div class="avatar-sm me-2">
                                        <div class="avatar-title bg-primary-subtle text-primary rounded-circle">
                                            {{ session_doc.username[0]|upper if session_doc.username else 'U' }}
                                        </div>
                                    </div>
                                    {{ session_doc.username }}
                                </div>
                            </td>
                            <td><span class="badge bg-info bg-opacity-10 text-info">{{ session_doc.category|title }}</span></td>
                            <td>
                                <div class="fw-medium">{{ session_doc.start_time.strftime('%b %d, %Y') if session_doc.start_time else 'N/A' }}</div>
                                <small class="text-muted">{{ session_doc.start_time.strftime('%H:%M:%S') if session_doc.start_time else '' }}</small>
                            </td>
                             <td>
                                <div class="fw-medium">{{ session_doc.end_time.strftime('%b %d, %Y') if session_doc.end_time else 'N/A' }}</div>
                                <small class="text-muted">{{ session_doc.end_time.strftime('%H:%M:%S') if session_doc.end_time else '' }}</small>
                            </td>
                            <td>
                                <span class="badge bg-{% if session_doc.status == 'completed' %}success{% elif session_doc.status == 'ongoing' %}warning{% else %}secondary{% endif %}-subtle text-{% if session_doc.status == 'completed' %}success{% elif session_doc.status == 'ongoing' %}warning{% else %}secondary{% endif %}">
                                    {{ session_doc.status|title }}
                                </span>
                            </td>
                            <td>
                                {% if session_doc.overall_score != "N/A (Not Completed)" and session_doc.overall_score is not none %}
                                    {{ "%.2f"|format(session_doc.overall_score) }}%
                                {% else %}
                                    N/A
                                {% endif %}
                            </td>
                            <td class="pe-3 text-end">
                                <button class="btn btn-sm btn-outline-primary me-1" data-bs-toggle="modal" data-bs-target="#sessionModal-{{ session_doc._id }}" title="View Details">
                                    <i class="bi bi-eye"></i>
                                </button>
                                <!-- Tombol Delete (fungsionalitas perlu diimplementasikan) -->
                                <!-- <button class="btn btn-sm btn-outline-danger" data-bs-toggle="tooltip" title="Delete Session (Not Implemented)">
                                    <i class="bi bi-trash"></i>
                                </button> -->
                            </td>
                        </tr>
                        {% endfor %}
                        {% else %}
                        <tr>
                            <td colspan="9" class="text-center text-muted py-4"> <!-- Sesuaikan colspan -->
                                No interview sessions found.
                            </td>
                        </tr>
                        {% endif %}
                    </tbody>
                </table>
            </div>
        </div>
        {% if total_pages and total_pages > 1 %}
        <div class="card-footer bg-white border-0 py-3">
            <nav aria-label="Page navigation">
                <ul class="pagination justify-content-center mb-0">
                    <li class="page-item {% if page == 1 %}disabled{% endif %}">
                        <a class="page-link" href="{{ url_for('admin.admin_sessions_route', page=page-1, search_email=search_email) if page > 1 else '#' }}" tabindex="-1">Previous</a>
                    </li>
                    {% for i in range(1, total_pages + 1) %}
                    <li class="page-item {% if i == page %}active{% endif %}">
                        <a class="page-link" href="{{ url_for('admin.admin_sessions_route', page=i, search_email=search_email) }}">{{ i }}</a>
                    </li>
                    {% endfor %}
                    <li class="page-item {% if page == total_pages %}disabled{% endif %}">
                        <a class="page-link" href="{{ url_for('admin.admin_sessions_route', page=page+1, search_email=search_email) if page < total_pages else '#' }}">Next</a>
                    </li>
                </ul>
            </nav>
        </div>
        {% endif %}
    </div>
</div>

<!-- Modals for session details -->
{% if sessions %}
{% for session_doc in sessions %}
<div class="modal fade" id="sessionModal-{{ session_doc._id }}" tabindex="-1" aria-labelledby="sessionModalLabel-{{ session_doc._id }}" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-scrollable">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="sessionModalLabel-{{ session_doc._id }}">Session Details: {{ session_doc._id }}</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <h6>User: {{ session_doc.username }} ({{ session_doc.user_email }})</h6>
                <h6>Category: {{ session_doc.category|title }}</h6>
                <h6>Status: <span class="badge bg-{% if session_doc.status == 'completed' %}success{% elif session_doc.status == 'ongoing' %}warning{% else %}secondary{% endif %}">{{ session_doc.status|title }}</span></h6>
                {% if session_doc.overall_score != "N/A (Not Completed)" and session_doc.overall_score is not none %}
                    <h6>Overall Score: {{ "%.2f"|format(session_doc.overall_score) }}%</h6>
                {% endif %}
                <hr>
                <h5>Questions & Answers:</h5>
                {% if session_doc.questions and session_doc.questions|length > 0 %}
                    {% for q_item in session_doc.questions %}
                        <div class="card mb-3">
                            <div class="card-header">
                                <strong>Q: {{ q_item.question_text }}</strong>
                            </div>
                            <div class="card-body">
                                <p><strong>User Answer:</strong><br> {{ q_item.user_answer if q_item.user_answer else "<em class='text-muted'>No answer provided.</em>" }}</p>
                                {% if q_item.evaluation %}
                                    <p class="mb-1"><strong>Evaluation Score:</strong> {{ "%.2f"|format(q_item.evaluation.score) }}%</p>
                                    <p class="mb-1"><strong>Feedback:</strong> {{ q_item.evaluation.feedback }}</p>
                                    <p class="mb-0"><strong>Matched Keywords:</strong>
                                        {% if q_item.evaluation.matched_keywords and q_item.evaluation.matched_keywords|length > 0 %}
                                            {% for kw in q_item.evaluation.matched_keywords %}
                                                <span class="badge bg-primary">{{ kw }}</span>
                                            {% endfor %}
                                        {% else %}
                                            <em class="text-muted">None</em>
                                        {% endif %}
                                    </p>
                                {% else %}
                                    <p class="text-muted"><em>Not evaluated yet.</em></p>
                                {% endif %}
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <p class="text-muted">No questions found in this session.</p>
                {% endif %}
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
            </div>
        </div>
    </div>
</div>
{% endfor %}
{% endif %}

<style>
    /* ... (style Anda sebelumnya) ... */
</style>

<script>
    // ... (script Anda sebelumnya untuk tooltips) ...
</script>
{% endblock %}